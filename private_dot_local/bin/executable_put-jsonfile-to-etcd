#!/bin/bash

usage() {
	echo "用途: 将给定的 JSON 文件的内容以指定的键前缀存储到 etcd 中"
	echo "用法: $0 <key_prefix> <json_file>"
}

# 检查参数数量
if [ "$#" -ne 2 ]; then
	usage
	exit 1
fi

# 检查 JSON 文件是否存在
if [ ! -f "$2" ]; then
	echo "错误: JSON 文件 '$2' 不存在"
	exit 1
fi

# 检查是否是合法的 JSON 格式
if ! jq -e . >/dev/null 2>&1 <"$2"; then
	echo "错误: 文件 '$2' 不是有效的 JSON 格式"
	exit 1
fi

# 设置环境变量
export ETCDCTL_API=3
export CERT="/etc/kubernetes/pki/etcd/server.crt"
export CACERT="/etc/kubernetes/pki/etcd/ca.crt"
export KEY="/etc/kubernetes/pki/etcd/server.key"
export ENDPOINT="/etc/kubernetes/pki/etcd/server.key"

# 获取参数
key_prefix="$1"
json_file="$2"
value="$(jq -c '.' "$json_file")"

# 将值存储到 etcd
etcdctl --endpoints "$ENDPOINT" --cert="$CERT" --key="$KEY" --cacert="$CACERT" put "$key_prefix" "$value"

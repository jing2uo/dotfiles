zstyle ':zim:zmodule' use 'degit'

ZIM_HOME=${HOME}/.config/zim
zstyle ':zim:completion' dumpfile "${ZIM_HOME}/zcompdump"
zstyle ':completion::complete:*' cache-path "${ZIM_HOME}/zcompcache"

if [[ ! -e ${ZIM_HOME}/zimfw.zsh ]]; then
  curl -fsSL --create-dirs -o ${ZIM_HOME}/zimfw.zsh \
    https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
fi

if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZDOTDIR:-${HOME}}/.zimrc ]]; then
  source ${ZIM_HOME}/zimfw.zsh init -q
fi

export WORDCHARS=${WORDCHARS/\//}
export PATH=${HOME}/.local/bin:$PATH
export ZIM_COMP=${ZIM_HOME}/completions
export HISTFILE=${ZIM_HOME}/zsh_history
export HISTSIZE=10000000
export SAVEHIST=10000000

# custom zsh completion
mkdir -p ${ZIM_COMP}
fpath+=($ZIM_COMP)


# 智能 sudo 切换函数
sudo-command-line() {
    [[ -z $BUFFER ]] && zle up-history
    if [[ $BUFFER == sudo\ * ]]; then
        LBUFFER="${LBUFFER#sudo }"
    else
        LBUFFER="sudo $LBUFFER"
    fi
}
zle -N sudo-command-line

# 绑定到双击 Esc
bindkey '\e\e' sudo-command-line

# Ctrl + 左右箭头按单词移动
bindkey '^[[1;5C' forward-word
bindkey '^[[1;5D' backward-word
# Ctrl + Backspace 删除单词
bindkey '^H' backward-kill-word

# 上下箭头智能搜索历史
autoload -U up-line-or-beginning-search
autoload -U down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search
bindkey '^[[A' up-line-or-beginning-search
bindkey '^[OA' up-line-or-beginning-search  
bindkey '^[[B' down-line-or-beginning-search
bindkey '^[OB' down-line-or-beginning-search

# 通配符 * 匹配隐藏文件
setopt globdots
# 多终端共享历史
setopt share_history
setopt hist_expire_dups_first
setopt hist_find_no_dups
setopt hist_save_no_dups
setopt hist_ignore_all_dups
setopt hist_ignore_space
setopt hist_reduce_blanks

alias curl="curl -k -s"
alias k="eza -lh"
alias kc="kubectl"
alias kx="kubectx"
alias kn="kubens"
alias fd="fdfind -H"
alias yt='mise x -- yt-dlp -f "bv*+ba" '
alias zz="zimfw clean && zimfw install && zimfw build -v"

# init zim
source ${ZIM_HOME}/init.zsh

# mise
if command -v mise >/dev/null 2>&1; then
  eval "$(mise activate zsh)"
fi

# atuin, save history
if command -v atuin >/dev/null 2>&1; then
  export ATUIN_NOBIND="true"
  eval "$(atuin init zsh)"
  bindkey '^r' atuin-search  # Ctrl+R 搜索历史
fi

# starship
if command -v starship >/dev/null 2>&1; then
  eval "$(starship init zsh)"
else
  export PS1="%F{green}%n@%m:%~%F{reset} \$ "
fi

# Python uv 
if command -v uv >/dev/null 2>&1; then
  eval "$(uv generate-shell-completion zsh)"
fi
